#!/usr/bin/env bash

OP=$1
if [ "$OP" == "init" ]
then
	VERSION="v0.1.0"
else
	VERSION=$(git tag -l --sort=-v:refname | head -n 1)
fi

# Parse
REGEX='v\([[:digit:]]\+.[[:digit:]]\+.[[:digit:]]\+\)\(-pre.\([[:digit:]]\+\)\)\?'
PREFIX=$(echo $VERSION | sed "s/$REGEX/\1/g")
PREFIX=${PREFIX#v}
PRE=$(echo $VERSION | sed "s/$REGEX/\3/g")

DIGITS=(${PREFIX//./ })
MAJOR=${DIGITS[0]}
MINOR=${DIGITS[1]}
PATCH=${DIGITS[2]}

# Increment
shift
case "$OP" in
	major)
		MAJOR=$((MAJOR+1))
		MINOR=0
		PATCH=0
		PRE=0
		;;
	minor)
		MINOR=$((MINOR+1))
		PATCH=0
		PRE=0
		;;
	patch)
		PATCH=$((PATCH+1))
		PRE=0
		;;
	pre)
		PRE=$((PRE+1))
		;;
	noop)
		;;
	init)
		MAJOR=0
		MINOR=1
		PATCH=0
		PRE=0
		;;
	*)
		echo "Usage:"
		echo "	git bump [major | minor | patch | pre | init]"
		exit -1
		;;
esac

# Compute tag string
TAG="v$MAJOR.$MINOR.$PATCH"
if [ "$PRE" -gt 0 ]
then
	TAG="$TAG-pre.$PRE"
fi

# Prompt
eval "git tag $TAG"
echo -e "Version bumped from ${YELLOW}$VERSION${CLEAR} to ${GREEN}$TAG${CLEAR}!"
